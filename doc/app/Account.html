<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8">

<title>class Account - Rails Application Documentation</title>

<link href="./fonts.css" rel="stylesheet">
<link href="./rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script src="./js/jquery.js"></script>
<script src="./js/navigation.js"></script>
<script src="./js/search_index.js"></script>
<script src="./js/search.js"></script>
<script src="./js/searcher.js"></script>
<script src="./js/darkfish.js"></script>


<body id="top" role="document" class="class">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="./index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="./table_of_contents.html#pages">Pages</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    <div id="parent-class-section" class="nav-section">
  <h3>Parent</h3>

  
  <p class="link">Object
  
</div>

    <div id="includes-section" class="nav-section">
  <h3>Included Modules</h3>

  <ul class="link-list">
  
  
    <li><span class="include">Mongoid::Document</span>
  
  
  
    <li><span class="include">Mongoid::Timestamps</span>
  
  
  </ul>
</div>

    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li class="calls-super" ><a href="#method-i-destroy">#destroy</a>
    
    <li ><a href="#method-i-get_customer">#get_customer</a>
    
    <li ><a href="#method-i-get_default_card">#get_default_card</a>
    
    <li ><a href="#method-i-is_valid">#is_valid</a>
    
    <li ><a href="#method-i-load_customer_info">#load_customer_info</a>
    
    <li ><a href="#method-i-save_with_stripe">#save_with_stripe</a>
    
    <li ><a href="#method-i-status_str">#status_str</a>
    
    <li ><a href="#method-i-stripe_error_handler">#stripe_error_handler</a>
    
    <li ><a href="#method-i-update_customer_info">#update_customer_info</a>
    
    <li ><a href="#method-i-update_with_stripe">#update_with_stripe</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="class-Account">
  <h1 id="class-Account" class="class">
    class Account
  </h1>

  <section class="description">
    
<p>The <a href="Account.html">Account</a> model is used to store the
Stripe.com customer_id and the current status of the account. The model is
also responsible for interfacing with the Stripe.com service to store,
retrieve and update the customer information stored there.</p>

  </section>

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <section class="constants-list">
      <header>
        <h3>Constants</h3>
      </header>
      <dl>
      
        <dt id="ACCOUNT_NAME">ACCOUNT_NAME
        
        <dd><p>STRIPE ACCOUNT DESCRIPTION</p>
        
      
        <dt id="ACTIVE">ACTIVE
        
        <dd><p><a href="Account.html#ACTIVE">ACTIVE</a> - <a
href="Account.html">Account</a> has been setup, the credit card has been <a
href="Account.html#ACTIVE">ACTIVE</a> and the customer identifier has been
retrieved from Stripe.com</p>
        
      
        <dt id="CLOSED">CLOSED
        
        <dd><p><a href="Account.html#CLOSED">CLOSED</a> - The account has been closed is
no longer active.</p>
        
      
        <dt id="INACTIVE">INACTIVE
        
        <dd><p><a href="Account.html#INACTIVE">INACTIVE</a> - The account&#39;s charge
card is not valid any longer, so the account has been moved to an <a
href="Account.html#INACTIVE">INACTIVE</a> state.</p>
        
      
        <dt id="NO_STRIPE">NO_STRIPE
        
        <dd><p><a href="Account.html#NO_STRIPE">NO_STRIPE</a> - The stripe account record
was deleted and there is no longer a stripe stored credit card associated
with the account.</p>
        
      
        <dt id="UNKNOWN">UNKNOWN
        
        <dd><p><a href="Account.html#UNKNOWN">UNKNOWN</a> - is the default starting status</p>
        
      
      </dl>
    </section>
    

    
    <section class="attribute-method-details" class="method-section">
      <header>
        <h3>Attributes</h3>
      </header>

      
      <div id="attribute-i-card_type" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">card_type</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-cardholder_email" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">cardholder_email</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>Add non database instance variables to store the temporary Stripe credit
card data in memory, but not in the database.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-cardholder_name" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">cardholder_name</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>Add non database instance variables to store the temporary Stripe credit
card data in memory, but not in the database.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-expiration" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">expiration</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-last4" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">last4</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-stripe_cc_token" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">stripe_cc_token</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>Add non database instance variables to store the temporary Stripe credit
card data in memory, but not in the database.</p>
        
        </div>
      </div>
      
    </section>
    

    
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-destroy" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">destroy</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>The destroy method overrides the standard destroy method for ActiveModel.
This version will delete Stripe.com customer account associated with the
stored customer_id.</p>
          
          
            <div class="method-calls-super">
              Calls superclass method
              
            </div>
          

          
          <div class="method-source-code" id="destroy-source">
            <pre><span class="ruby-comment"># File app/models/account.rb, line 205</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">destroy</span>

  <span class="ruby-comment"># Destroy the customer account on Stripe.com if the id is present.</span>
  <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">customer_id</span>.<span class="ruby-identifier">present?</span>
    <span class="ruby-keyword">begin</span>
      <span class="ruby-constant">Stripe</span>.<span class="ruby-identifier">api_key</span> = <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;API_KEY&#39;</span>]
      <span class="ruby-identifier">customer</span> = <span class="ruby-constant">Stripe</span><span class="ruby-operator">::</span><span class="ruby-constant">Customer</span>.<span class="ruby-identifier">retrieve</span>(<span class="ruby-node">&quot;#{self.customer_id}&quot;</span>)
      <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">delete</span>
    <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Stripe</span><span class="ruby-operator">::</span><span class="ruby-constant">StripeError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">stripe_error</span>
      <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;[Account.delete] stripe error = #{stripe_error.message}&quot;</span>)
      <span class="ruby-identifier">errors</span>[<span class="ruby-value">:customer_id</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">stripe_error</span>.<span class="ruby-identifier">message</span>

      <span class="ruby-comment"># continue to raise the exception</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">Stripe</span><span class="ruby-operator">::</span><span class="ruby-constant">StripeError</span>, <span class="ruby-identifier">stripe_error</span>.<span class="ruby-identifier">message</span>
    <span class="ruby-keyword">end</span>
   <span class="ruby-keyword">end</span>

   <span class="ruby-keyword">super</span>()
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-get_customer" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_customer</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>The <a href="Account.html#method-i-get_customer">#get_customer</a> method
retrieves the customer information from Stripe.com. It then stores some of
the information in memory for desplaying to the user. None of the retrieved
information is stored in the database. The retrieved information sets
in-memory instance variables for:</p>
<ul><li>
<p><a href="Account.html#attribute-i-cardholder_name">#cardholder_name</a></p>
</li><li>
<p><a href="Account.html#attribute-i-cardholder_email">#cardholder_email</a></p>
</li><li>
<p>last4 - digits of the credit card</p>
</li><li>
<p>expiration date - month - year format</p>
</li><li>
<p>sets the account status to <a href="Account.html#INACTIVE">INACTIVE</a> if
the card is deliquent</p>
</li></ul>
          
          

          
          <div class="method-source-code" id="get_customer-source">
            <pre><span class="ruby-comment"># File app/models/account.rb, line 93</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_customer</span>
  <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">customer_id</span>.<span class="ruby-identifier">present?</span>

    <span class="ruby-keyword">begin</span>
      <span class="ruby-constant">Stripe</span>.<span class="ruby-identifier">api_key</span> = <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;API_KEY&#39;</span>]
      <span class="ruby-identifier">customer</span> = <span class="ruby-constant">Stripe</span><span class="ruby-operator">::</span><span class="ruby-constant">Customer</span>.<span class="ruby-identifier">retrieve</span>(<span class="ruby-node">&quot;#{self.customer_id}&quot;</span>)

      <span class="ruby-keyword">if</span> <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:deleted</span>)
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">status</span> = <span class="ruby-constant">NO_STRIPE</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">load_customer_info</span>(<span class="ruby-identifier">customer</span>)
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">delinquent</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">status</span> = <span class="ruby-constant">INACTIVE</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

     <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Stripe</span><span class="ruby-operator">::</span><span class="ruby-constant">StripeError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">stripe_error</span>
      <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;[Account.get_customer] stripe error = #{stripe_error.message}&quot;</span>)
      <span class="ruby-identifier">errors</span>[<span class="ruby-value">:customer_id</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">stripe_error</span>.<span class="ruby-identifier">message</span>
      <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">return</span> <span class="ruby-identifier">customer</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span>
   <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-save_with_stripe" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">save_with_stripe</span><span
            class="method-args">(params)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>The <a href="Account.html#method-i-save_with_stripe">#save_with_stripe</a>
will save the account record and corresponding stripe customer_id in the
database. The <a
href="Account.html#attribute-i-stripe_cc_token">#stripe_cc_token</a> is not
saved since it is only useful for one transaction.</p>

<p>The <a href="Account.html#method-i-save_with_stripe">#save_with_stripe</a>
method takes the standard params hash that is passed to the create and
update methods. This params hash should include:</p>
<ul><li>
<p><a href="Account.html#attribute-i-stripe_cc_token">#stripe_cc_token</a></p>
</li><li>
<p><a href="Account.html#attribute-i-cardholder_email">#cardholder_email</a></p>
</li></ul>
          
          

          
          <div class="method-source-code" id="save_with_stripe-source">
            <pre><span class="ruby-comment"># File app/models/account.rb, line 133</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">save_with_stripe</span>(<span class="ruby-identifier">params</span>)
  <span class="ruby-identifier">account_valid</span> = <span class="ruby-keyword">true</span>

  <span class="ruby-keyword">begin</span>

    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">account_valid</span> = <span class="ruby-identifier">is_valid</span>(<span class="ruby-identifier">params</span>))
      <span class="ruby-comment"># Create a stripe customer</span>
      <span class="ruby-constant">Stripe</span>.<span class="ruby-identifier">api_key</span> = <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;API_KEY&#39;</span>]

      <span class="ruby-identifier">customer</span> = <span class="ruby-constant">Stripe</span><span class="ruby-operator">::</span><span class="ruby-constant">Customer</span>.<span class="ruby-identifier">create</span>(
        <span class="ruby-value">:description</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;#{ACCOUNT_NAME} customer account.&quot;</span>,
        <span class="ruby-value">:card</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:account</span>][<span class="ruby-value">:stripe_cc_token</span>],
        <span class="ruby-value">:email</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:cardholder_email</span>]
      )

      <span class="ruby-identifier">load_customer_info</span>(<span class="ruby-identifier">customer</span>)
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">status</span> = <span class="ruby-constant">ACTIVE</span>

      <span class="ruby-comment"># Attempt to save the record</span>
      <span class="ruby-identifier">account_valid</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">save</span> <span class="ruby-operator">?</span> <span class="ruby-keyword">true</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Stripe</span><span class="ruby-operator">::</span><span class="ruby-constant">StripeError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">stripe_error</span>
    <span class="ruby-identifier">account_valid</span> = <span class="ruby-identifier">stripe_error_handler</span>(<span class="ruby-identifier">stripe_error</span>, <span class="ruby-constant">INACTIVE</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">account_valid</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-status_str" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">status_str</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>The <a href="Account.html#method-i-status_str">#status_str</a> method
returns the account status in string format</p>
          
          

          
          <div class="method-source-code" id="status_str-source">
            <pre><span class="ruby-comment"># File app/models/account.rb, line 65</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">status_str</span>
  <span class="ruby-keyword">case</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">status</span>
  <span class="ruby-keyword">when</span> <span class="ruby-constant">ACTIVE</span>
    <span class="ruby-string">&quot;Active&quot;</span>
  <span class="ruby-keyword">when</span> <span class="ruby-constant">INACTIVE</span>
    <span class="ruby-string">&quot;Inactive&quot;</span>
  <span class="ruby-keyword">when</span> <span class="ruby-constant">CLOSED</span>
    <span class="ruby-string">&quot;Closed&quot;</span>
  <span class="ruby-keyword">when</span> <span class="ruby-constant">NO_STRIPE</span>
    <span class="ruby-string">&quot;No Stripe Account&quot;</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-string">&quot;Unknown&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-update_with_stripe" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">update_with_stripe</span><span
            class="method-args">(params)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>The update with_stripe method will update the account record and
corresponding stripe customer_id in the database. The <a
href="Account.html#attribute-i-stripe_cc_token">#stripe_cc_token</a> is not
saved since it is only useful for one transaction.</p>

<p>The <a
href="Account.html#method-i-update_with_stripe">#update_with_stripe</a>
method takes the standard params hash that is passed to the create and
update methods.</p>
          
          

          
          <div class="method-source-code" id="update_with_stripe-source">
            <pre><span class="ruby-comment"># File app/models/account.rb, line 170</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">update_with_stripe</span>(<span class="ruby-identifier">params</span>)
  <span class="ruby-identifier">account_valid</span> = <span class="ruby-keyword">true</span>

  <span class="ruby-keyword">begin</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">account_valid</span> = <span class="ruby-identifier">is_valid</span>(<span class="ruby-identifier">params</span>))
      <span class="ruby-comment"># Create a stripe customer</span>
      <span class="ruby-constant">Stripe</span>.<span class="ruby-identifier">api_key</span> = <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;API_KEY&#39;</span>]
      <span class="ruby-identifier">customer</span> = <span class="ruby-constant">Stripe</span><span class="ruby-operator">::</span><span class="ruby-constant">Customer</span>.<span class="ruby-identifier">retrieve</span>(<span class="ruby-node">&quot;#{self.customer_id}&quot;</span>)

      <span class="ruby-keyword">if</span> <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:deleted</span>)
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">status</span> = <span class="ruby-constant">NO_STRIPE</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">update_customer_info</span>(<span class="ruby-identifier">customer</span>, <span class="ruby-identifier">params</span>)

        <span class="ruby-identifier">load_customer_info</span>(<span class="ruby-identifier">customer</span>)

        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">status</span> = <span class="ruby-constant">ACTIVE</span>

        <span class="ruby-comment"># Attempt to save the record</span>
        <span class="ruby-identifier">account_valid</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">save</span> <span class="ruby-operator">?</span> <span class="ruby-keyword">true</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">false</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Stripe</span><span class="ruby-operator">::</span><span class="ruby-constant">StripeError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">stripe_error</span>
    <span class="ruby-identifier">account_valid</span> = <span class="ruby-identifier">stripe_error_handler</span>(<span class="ruby-identifier">stripe_error</span>, <span class="ruby-constant">INACTIVE</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">account_valid</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
     <section id="protected-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Protected Instance Methods</h3>
       </header>

    
      <div id="method-i-get_default_card" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_default_card</span><span
            class="method-args">(customer)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>The <a href="Account.html#method-i-get_default_card">#get_default_card</a>
is a method that will return the default card associated with a customer
account.</p>
          
          

          
          <div class="method-source-code" id="get_default_card-source">
            <pre><span class="ruby-comment"># File app/models/account.rb, line 272</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_default_card</span>(<span class="ruby-identifier">customer</span>)
  <span class="ruby-identifier">default_card</span> = <span class="ruby-keyword">nil</span>

  <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">cards</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">card</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">card</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">default_card</span>
      <span class="ruby-identifier">default_card</span> = <span class="ruby-identifier">card</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">default_card</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-is_valid" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">is_valid</span><span
            class="method-args">(params)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>The <a href="Account.html#method-i-is_valid">#is_valid</a> helper method
checks to make sure the user included <a
href="Account.html#attribute-i-cardholder_name">#cardholder_name</a>, <a
href="Account.html#attribute-i-cardholder_email">#cardholder_email</a>, and
that the <a
href="Account.html#attribute-i-stripe_cc_token">#stripe_cc_token</a> was
returned from the Stipe.com service.</p>
          
          

          
          <div class="method-source-code" id="is_valid-source">
            <pre><span class="ruby-comment"># File app/models/account.rb, line 289</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">is_valid</span>(<span class="ruby-identifier">params</span>)
  <span class="ruby-identifier">account_valid</span> = <span class="ruby-keyword">true</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:cardholder_name</span>].<span class="ruby-identifier">blank?</span>
    <span class="ruby-identifier">errors</span>[<span class="ruby-value">:cardholder_name</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;cannot be blank.&quot;</span>
    <span class="ruby-identifier">account_valid</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:cardholder_email</span>].<span class="ruby-identifier">blank?</span>
    <span class="ruby-identifier">errors</span>[<span class="ruby-value">:cardholder_email</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;cannot be blank.&quot;</span>
    <span class="ruby-identifier">account_valid</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:account</span>][<span class="ruby-value">:stripe_cc_token</span>].<span class="ruby-identifier">blank?</span>
    <span class="ruby-identifier">errors</span>[<span class="ruby-value">:base</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;- Could not get a valid response from Stripe.com&quot;</span>
    <span class="ruby-identifier">account_valid</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">account_valid</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-load_customer_info" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">load_customer_info</span><span
            class="method-args">(customer)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>This helper method is used to load card and customer information into the
instance variables for the <a href="Account.html">Account</a> model.</p>
          
          

          
          <div class="method-source-code" id="load_customer_info-source">
            <pre><span class="ruby-comment"># File app/models/account.rb, line 254</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">load_customer_info</span>(<span class="ruby-identifier">customer</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">customer_id</span> = <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">id</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">cardholder_email</span> = <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">email</span>

  <span class="ruby-identifier">customer_card</span> = <span class="ruby-identifier">get_default_card</span>(<span class="ruby-identifier">customer</span>)

  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">cardholder_name</span> = <span class="ruby-identifier">customer_card</span>.<span class="ruby-identifier">name</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">card_type</span> = <span class="ruby-identifier">customer_card</span>.<span class="ruby-identifier">type</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">last4</span> = <span class="ruby-identifier">customer_card</span>.<span class="ruby-identifier">last4</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">expiration</span> =  <span class="ruby-identifier">customer_card</span>.<span class="ruby-identifier">exp_month</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span>
    <span class="ruby-string">&#39;/&#39;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">customer_card</span>.<span class="ruby-identifier">exp_year</span>.<span class="ruby-identifier">to_s</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-stripe_error_handler" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">stripe_error_handler</span><span
            class="method-args">(stripe_error, status=nil)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>This helper method handles logging and setting stripe errors. It</p>
          
          

          
          <div class="method-source-code" id="stripe_error_handler-source">
            <pre><span class="ruby-comment"># File app/models/account.rb, line 231</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">stripe_error_handler</span>(<span class="ruby-identifier">stripe_error</span>, <span class="ruby-identifier">status</span>=<span class="ruby-keyword">nil</span>)
  <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;[Account] stripe error = #{stripe_error.message}&quot;</span>)
  <span class="ruby-identifier">errors</span>[<span class="ruby-value">:customer_id</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">stripe_error</span>.<span class="ruby-identifier">message</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">status</span> = <span class="ruby-identifier">status</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">status</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-update_customer_info" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">update_customer_info</span><span
            class="method-args">(customer, params)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Little helper method to update customer record with stripe and contact
information.</p>
          
          

          
          <div class="method-source-code" id="update_customer_info-source">
            <pre><span class="ruby-comment"># File app/models/account.rb, line 242</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">update_customer_info</span>(<span class="ruby-identifier">customer</span>, <span class="ruby-identifier">params</span>)
  <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">card</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:account</span>][<span class="ruby-value">:stripe_cc_token</span>]
  <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">description</span> = <span class="ruby-node">&quot;#{ACCOUNT_NAME} account for #{params[cardholder_name]}&quot;</span>
  <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">email</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:cardholder_email</span>]

  <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">save</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>
</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://rdoc.rubyforge.org">RDoc</a> 4.1.1.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

