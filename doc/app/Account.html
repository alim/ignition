<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">

<title>class Account - Rails Application Documentation</title>

<link type="text/css" media="screen" href="./rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script type="text/javascript" charset="utf-8" src="./js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/darkfish.js"></script>


<body id="top" class="class">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="./index.html">Home</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  <div id="file-metadata">
    <nav id="file-list-section" class="section">
  <h3 class="section-header">Defined In</h3>
  <ul>
    <li>app/models/account.rb
  </ul>
</nav>

    
  </div>

  <div id="class-metadata">
    
    <nav id="parent-class-section" class="section">
  <h3 class="section-header">Parent</h3>
  
  <p class="link">Object
  
</nav>

    <!-- Included Modules -->
<nav id="includes-section" class="section">
  <h3 class="section-header">Included Modules</h3>

  <ul class="link-list">
  
  
    <li><span class="include">Mongoid::Document</span>
  
  
  
    <li><span class="include">Mongoid::Timestamps</span>
  
  
  </ul>
</nav>

    <!-- Method Quickref -->
<nav id="method-list-section" class="section">
  <h3 class="section-header">Methods</h3>

  <ul class="link-list">
    
    <li><a href="#method-i-destroy">#destroy</a>
    
    <li><a href="#method-i-get_customer">#get_customer</a>
    
    <li><a href="#method-i-get_default_card">#get_default_card</a>
    
    <li><a href="#method-i-is_valid">#is_valid</a>
    
    <li><a href="#method-i-load_customer_info">#load_customer_info</a>
    
    <li><a href="#method-i-save_with_stripe">#save_with_stripe</a>
    
    <li><a href="#method-i-status_str">#status_str</a>
    
    <li><a href="#method-i-update_with_stripe">#update_with_stripe</a>
    
  </ul>
</nav>

  </div>

  <div id="project-metadata">
    <nav id="fileindex-section" class="section project-section">
  <h3 class="section-header">Pages</h3>

  <ul>
  
    <li class="file"><a href="./README_rdoc.html">README</a>
  
  </ul>
</nav>

    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="./Account.html">Account</a>
  
    <li><a href="./AccountsController.html">AccountsController</a>
  
    <li><a href="./AccountsHelper.html">AccountsHelper</a>
  
    <li><a href="./AdminController.html">AdminController</a>
  
    <li><a href="./AdminHelper.html">AdminHelper</a>
  
    <li><a href="./ApplicationController.html">ApplicationController</a>
  
    <li><a href="./ApplicationHelper.html">ApplicationHelper</a>
  
    <li><a href="./Group.html">Group</a>
  
    <li><a href="./GroupMailer.html">GroupMailer</a>
  
    <li><a href="./GroupsController.html">GroupsController</a>
  
    <li><a href="./GroupsHelper.html">GroupsHelper</a>
  
    <li><a href="./HomeController.html">HomeController</a>
  
    <li><a href="./HomeHelper.html">HomeHelper</a>
  
    <li><a href="./Oops.html">Oops</a>
  
    <li><a href="./Subscription.html">Subscription</a>
  
    <li><a href="./SubscriptionsController.html">SubscriptionsController</a>
  
    <li><a href="./SubscriptionsHelper.html">SubscriptionsHelper</a>
  
    <li><a href="./User.html">User</a>
  
    <li><a href="./UserMailer.html">UserMailer</a>
  
    <li><a href="./UsersController.html">UsersController</a>
  
    <li><a href="./UsersHelper.html">UsersHelper</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation">
  <h1 class="class">class Account</h1>

  <div id="description" class="description">
    
<p>The <a href="Account.html">Account</a> model is used to store the
Stripe.com customer_id and the current status of the account. The model is
also responsible for interfacing with the Stripe.com service to store,
retrieve and update the customer information stored there.</p>

  </div><!-- description -->

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <!-- Constants -->
    <section id="constants-list" class="section">
      <h3 class="section-header">Constants</h3>
      <dl>
      
        <dt id="ACCOUNT_NAME">ACCOUNT_NAME
        
        <dd class="description"><p>STRIPE ACCOUNT DESCRIPTION</p>
        
      
        <dt id="ACTIVE">ACTIVE
        
        <dd class="description"><p><a href="Account.html#ACTIVE">ACTIVE</a> - <a
href="Account.html">Account</a> has been setup, the credit card has been <a
href="Account.html#ACTIVE">ACTIVE</a> and the customer identifier has been
retrieved from Stripe.com</p>
        
      
        <dt id="CLOSED">CLOSED
        
        <dd class="description"><p><a href="Account.html#CLOSED">CLOSED</a> - The account has been closed is
no longer active.</p>
        
      
        <dt id="INACTIVE">INACTIVE
        
        <dd class="description"><p><a href="Account.html#INACTIVE">INACTIVE</a> - The account's charge card is
not valid any longer, so the account has been moved to an <a
href="Account.html#INACTIVE">INACTIVE</a> state.</p>
        
      
        <dt id="NO_STRIPE">NO_STRIPE
        
        <dd class="description"><p><a href="Account.html#NO_STRIPE">NO_STRIPE</a> - The stripe account record
was deleted and there is no longer a stripe stored credit card associated
with the account.</p>
        
      
        <dt id="UNKNOWN">UNKNOWN
        
        <dd class="description"><p><a href="Account.html#UNKNOWN">UNKNOWN</a> - is the default starting status</p>
        
      
      </dl>
    </section>
    

    
    <!-- Attributes -->
    <section id="attribute-method-details" class="method-section section">
      <h3 class="section-header">Attributes</h3>

      
      <div id="attribute-i-card_type" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">card_type</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-cardholder_email" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">cardholder_email</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>Add non database instance variables to store the temporary Stripe credit
card data in memory, but not in the database.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-cardholder_name" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">cardholder_name</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>Add non database instance variables to store the temporary Stripe credit
card data in memory, but not in the database.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-expiration" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">expiration</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-last4" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">last4</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-stripe_cc_token" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">stripe_cc_token</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>Add non database instance variables to store the temporary Stripe credit
card data in memory, but not in the database.</p>
        
        </div>
      </div>
      
    </section><!-- attribute-method-details -->
    

    <!-- Methods -->
    
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Instance Methods</h3>

    
      <div id="method-i-destroy" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">destroy</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>The destory method overides the standard destory method for ActiveModel.
This version will delete Stripe.com customer account associated with the
stored customer_id.</p>
          

          
          <div class="method-source-code" id="destroy-source">
            <pre><span class="ruby-comment"># File app/models/account.rb, line 214</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">destroy</span>
  
  <span class="ruby-comment"># Destroy the customer account on Stripe.com if the id is present.</span>
  <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">customer_id</span>.<span class="ruby-identifier">present?</span>
    <span class="ruby-keyword">begin</span>
      <span class="ruby-constant">Stripe</span>.<span class="ruby-identifier">api_key</span> = <span class="ruby-constant">ENV</span>[<span class="ruby-string">'API_KEY'</span>]
      <span class="ruby-identifier">customer</span> = <span class="ruby-constant">Stripe</span><span class="ruby-operator">::</span><span class="ruby-constant">Customer</span>.<span class="ruby-identifier">retrieve</span>(<span class="ruby-node">&quot;#{self.customer_id}&quot;</span>)
      <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">delete</span>
    <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Stripe</span><span class="ruby-operator">::</span><span class="ruby-constant">StripeError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">stripe_error</span>
      <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;[Account.delete] stripe error = #{stripe_error.message}&quot;</span>)
      <span class="ruby-identifier">errors</span>[<span class="ruby-value">:customer_id</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">stripe_error</span>.<span class="ruby-identifier">message</span>
      
      <span class="ruby-comment"># continue to raise the exception</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">Stripe</span><span class="ruby-operator">::</span><span class="ruby-constant">StripeError</span>, <span class="ruby-identifier">stripe_error</span>.<span class="ruby-identifier">message</span>
    <span class="ruby-keyword">end</span>
   <span class="ruby-keyword">end</span>

   <span class="ruby-keyword">super</span>()
<span class="ruby-keyword">end</span></pre>
          </div><!-- destroy-source -->
          
        </div>

        

        
      </div><!-- destroy-method -->

    
      <div id="method-i-get_customer" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_customer</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>The <a href="Account.html#method-i-get_customer">#get_customer</a> method
retrieves the customer information from Stripe.com. It then stores some of
the information in memory for desplaying to the user. None of the retrieved
information is stored in the database. The retrieved information sets
in-memory instance variables for:</p>
<ul><li>
<p><a href="Account.html#attribute-i-cardholder_name">#cardholder_name</a></p>
</li><li>
<p><a href="Account.html#attribute-i-cardholder_email">#cardholder_email</a></p>
</li><li>
<p>last4 - digits of the credit card</p>
</li><li>
<p>expiration date - month - year format</p>
</li><li>
<p>sets the account status to <a href="Account.html#INACTIVE">INACTIVE</a> if
the card is deliquent</p>
</li></ul>
          

          
          <div class="method-source-code" id="get_customer-source">
            <pre><span class="ruby-comment"># File app/models/account.rb, line 92</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_customer</span>
  <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">customer_id</span>.<span class="ruby-identifier">present?</span>

    <span class="ruby-keyword">begin</span>
      <span class="ruby-constant">Stripe</span>.<span class="ruby-identifier">api_key</span> = <span class="ruby-constant">ENV</span>[<span class="ruby-string">'API_KEY'</span>]
      <span class="ruby-identifier">customer</span> = <span class="ruby-constant">Stripe</span><span class="ruby-operator">::</span><span class="ruby-constant">Customer</span>.<span class="ruby-identifier">retrieve</span>(<span class="ruby-node">&quot;#{self.customer_id}&quot;</span>)

      <span class="ruby-keyword">if</span> <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:deleted</span>)
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">status</span> = <span class="ruby-constant">NO_STRIPE</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">load_customer_info</span>(<span class="ruby-identifier">customer</span>)
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">delinquent</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">status</span> = <span class="ruby-constant">INACTIVE</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

     <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Stripe</span><span class="ruby-operator">::</span><span class="ruby-constant">StripeError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">stripe_error</span>
      <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;[Account.get_customer] stripe error = #{stripe_error.message}&quot;</span>)
      <span class="ruby-identifier">errors</span>[<span class="ruby-value">:customer_id</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">stripe_error</span>.<span class="ruby-identifier">message</span>
      <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">return</span> <span class="ruby-identifier">customer</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span>
   <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_customer-source -->
          
        </div>

        

        
      </div><!-- get_customer-method -->

    
      <div id="method-i-save_with_stripe" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">save_with_stripe</span><span
            class="method-args">(params)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>The <a href="Account.html#method-i-save_with_stripe">#save_with_stripe</a>
will save the account record and corresponding stripe customer_id in the
database. The <a
href="Account.html#attribute-i-stripe_cc_token">#stripe_cc_token</a> is not
saved since it is only useful for one transaction.</p>

<p>The <a href="Account.html#method-i-save_with_stripe">#save_with_stripe</a>
method takes the standard params hash that is passed to the create and
update methods. This params hash should include:</p>
<ul><li>
<p><a href="Account.html#attribute-i-stripe_cc_token">#stripe_cc_token</a></p>
</li><li>
<p><a href="Account.html#attribute-i-cardholder_email">#cardholder_email</a></p>
</li></ul>
          

          
          <div class="method-source-code" id="save_with_stripe-source">
            <pre><span class="ruby-comment"># File app/models/account.rb, line 132</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">save_with_stripe</span>(<span class="ruby-identifier">params</span>)
  <span class="ruby-identifier">account_valid</span> = <span class="ruby-keyword">true</span>

  <span class="ruby-keyword">begin</span>

    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">account_valid</span> = <span class="ruby-identifier">is_valid</span>(<span class="ruby-identifier">params</span>))
      <span class="ruby-comment"># Create a stripe customer</span>
      <span class="ruby-constant">Stripe</span>.<span class="ruby-identifier">api_key</span> = <span class="ruby-constant">ENV</span>[<span class="ruby-string">'API_KEY'</span>]

      <span class="ruby-identifier">customer</span> = <span class="ruby-constant">Stripe</span><span class="ruby-operator">::</span><span class="ruby-constant">Customer</span>.<span class="ruby-identifier">create</span>(
        <span class="ruby-value">:description</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;#{ACCOUNT_NAME} customer account.&quot;</span>,
        <span class="ruby-value">:card</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:account</span>][<span class="ruby-value">:stripe_cc_token</span>],
        <span class="ruby-value">:email</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:cardholder_email</span>]
      )
      
      <span class="ruby-identifier">load_customer_info</span>(<span class="ruby-identifier">customer</span>)
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">status</span> = <span class="ruby-constant">ACTIVE</span>
      
      <span class="ruby-comment"># Attempt to save the record</span>
      <span class="ruby-identifier">account_valid</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">save</span> <span class="ruby-operator">?</span> <span class="ruby-keyword">true</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Stripe</span><span class="ruby-operator">::</span><span class="ruby-constant">StripeError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">stripe_error</span>
    <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;[Account.save_with_stripe] stripe error = #{stripe_error.message}&quot;</span>)
    <span class="ruby-identifier">errors</span>[<span class="ruby-value">:customer_id</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">stripe_error</span>.<span class="ruby-identifier">message</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">status</span> = <span class="ruby-constant">INACTIVE</span>
    <span class="ruby-identifier">account_valid</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">account_valid</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- save_with_stripe-source -->
          
        </div>

        

        
      </div><!-- save_with_stripe-method -->

    
      <div id="method-i-status_str" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">status_str</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>The <a href="Account.html#method-i-status_str">#status_str</a> method
returns the account status in string format</p>
          

          
          <div class="method-source-code" id="status_str-source">
            <pre><span class="ruby-comment"># File app/models/account.rb, line 64</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">status_str</span>
  <span class="ruby-keyword">case</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">status</span>
  <span class="ruby-keyword">when</span> <span class="ruby-constant">ACTIVE</span>
    <span class="ruby-string">&quot;Active&quot;</span>
  <span class="ruby-keyword">when</span> <span class="ruby-constant">INACTIVE</span>
    <span class="ruby-string">&quot;Inactive&quot;</span>
  <span class="ruby-keyword">when</span> <span class="ruby-constant">CLOSED</span>
    <span class="ruby-string">&quot;Closed&quot;</span>
  <span class="ruby-keyword">when</span> <span class="ruby-constant">NO_STRIPE</span>
    <span class="ruby-string">&quot;No Stripe Account&quot;</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-string">&quot;Unknown&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- status_str-source -->
          
        </div>

        

        
      </div><!-- status_str-method -->

    
      <div id="method-i-update_with_stripe" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">update_with_stripe</span><span
            class="method-args">(params)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>The update with_stripe method will update the account record and
corresponding stripe customer_id in the database. The <a
href="Account.html#attribute-i-stripe_cc_token">#stripe_cc_token</a> is not
saved since it is only useful for one transaction.</p>

<p>The <a
href="Account.html#method-i-update_with_stripe">#update_with_stripe</a>
method takes the standard params hash that is passed to the create and
update methods.</p>
          

          
          <div class="method-source-code" id="update_with_stripe-source">
            <pre><span class="ruby-comment"># File app/models/account.rb, line 172</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">update_with_stripe</span>(<span class="ruby-identifier">params</span>)
  <span class="ruby-identifier">account_valid</span> = <span class="ruby-keyword">true</span>

  <span class="ruby-keyword">begin</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">account_valid</span> = <span class="ruby-identifier">is_valid</span>(<span class="ruby-identifier">params</span>))
      <span class="ruby-comment"># Create a stripe customer</span>
      <span class="ruby-constant">Stripe</span>.<span class="ruby-identifier">api_key</span> = <span class="ruby-constant">ENV</span>[<span class="ruby-string">'API_KEY'</span>]
      <span class="ruby-identifier">customer</span> = <span class="ruby-constant">Stripe</span><span class="ruby-operator">::</span><span class="ruby-constant">Customer</span>.<span class="ruby-identifier">retrieve</span>(<span class="ruby-node">&quot;#{self.customer_id}&quot;</span>)

      <span class="ruby-keyword">if</span> <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:deleted</span>)
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">status</span> = <span class="ruby-constant">NO_STRIPE</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">card</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:account</span>][<span class="ruby-value">:stripe_cc_token</span>]
        <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">description</span> = <span class="ruby-node">&quot;#{ACCOUNT_NAME} account for #{params[cardholder_name]}&quot;</span>
        <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">email</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:cardholder_email</span>]
        
        <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">save</span>

        <span class="ruby-identifier">load_customer_info</span>(<span class="ruby-identifier">customer</span>)

        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">status</span> = <span class="ruby-constant">ACTIVE</span>

        <span class="ruby-comment"># Attempt to save the record</span>
        <span class="ruby-identifier">account_valid</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">save</span> <span class="ruby-operator">?</span> <span class="ruby-keyword">true</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">false</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Stripe</span><span class="ruby-operator">::</span><span class="ruby-constant">StripeError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">stripe_error</span>
    <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;[Account.update_with_stripe] stripe error = #{stripe_error.message}&quot;</span>)
    <span class="ruby-identifier">errors</span>[<span class="ruby-value">:customer_id</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">stripe_error</span>.<span class="ruby-identifier">message</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">status</span> = <span class="ruby-constant">INACTIVE</span>
    <span class="ruby-identifier">account_valid</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">account_valid</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- update_with_stripe-source -->
          
        </div>

        

        
      </div><!-- update_with_stripe-method -->

    
    </section><!-- public-instance-method-details -->
  
     <section id="protected-instance-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Protected Instance Methods</h3>

    
      <div id="method-i-get_default_card" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_default_card</span><span
            class="method-args">(customer)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>The <a href="Account.html#method-i-get_default_card">#get_default_card</a>
is a method that will return the default card associated with a customer
account.</p>
          

          
          <div class="method-source-code" id="get_default_card-source">
            <pre><span class="ruby-comment"># File app/models/account.rb, line 259</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_default_card</span>(<span class="ruby-identifier">customer</span>)
  <span class="ruby-identifier">default_card</span> = <span class="ruby-keyword">nil</span>
  
  <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">cards</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">card</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">card</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">default_card</span>
      <span class="ruby-identifier">default_card</span> = <span class="ruby-identifier">card</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">default_card</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_default_card-source -->
          
        </div>

        

        
      </div><!-- get_default_card-method -->

    
      <div id="method-i-is_valid" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">is_valid</span><span
            class="method-args">(params)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>The <a href="Account.html#method-i-is_valid">#is_valid</a> helper method
checks to make sure the user included <a
href="Account.html#attribute-i-cardholder_name">#cardholder_name</a>, <a
href="Account.html#attribute-i-cardholder_email">#cardholder_email</a>, and
that the <a
href="Account.html#attribute-i-stripe_cc_token">#stripe_cc_token</a> was
returned from the Stipe.com service.</p>
          

          
          <div class="method-source-code" id="is_valid-source">
            <pre><span class="ruby-comment"># File app/models/account.rb, line 276</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">is_valid</span>(<span class="ruby-identifier">params</span>)
  <span class="ruby-identifier">account_valid</span> = <span class="ruby-keyword">true</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:cardholder_name</span>].<span class="ruby-identifier">blank?</span>
    <span class="ruby-identifier">errors</span>[<span class="ruby-value">:cardholder_name</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;cannot be blank.&quot;</span>
    <span class="ruby-identifier">account_valid</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:cardholder_email</span>].<span class="ruby-identifier">blank?</span>
    <span class="ruby-identifier">errors</span>[<span class="ruby-value">:cardholder_email</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;cannot be blank.&quot;</span>
    <span class="ruby-identifier">account_valid</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:account</span>][<span class="ruby-value">:stripe_cc_token</span>].<span class="ruby-identifier">blank?</span>
    <span class="ruby-identifier">errors</span>[<span class="ruby-value">:base</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;- Could not get a valid response from Stripe.com&quot;</span>
    <span class="ruby-identifier">account_valid</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">account_valid</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- is_valid-source -->
          
        </div>

        

        
      </div><!-- is_valid-method -->

    
      <div id="method-i-load_customer_info" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">load_customer_info</span><span
            class="method-args">(customer)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>This helper method is used to load card and customer information into the
instance variables for the <a href="Account.html">Account</a> model.</p>
          

          
          <div class="method-source-code" id="load_customer_info-source">
            <pre><span class="ruby-comment"># File app/models/account.rb, line 241</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">load_customer_info</span>(<span class="ruby-identifier">customer</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">customer_id</span> = <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">id</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">cardholder_email</span> = <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">email</span>
  
  <span class="ruby-identifier">customer_card</span> = <span class="ruby-identifier">get_default_card</span>(<span class="ruby-identifier">customer</span>)

  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">cardholder_name</span> = <span class="ruby-identifier">customer_card</span>.<span class="ruby-identifier">name</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">card_type</span> = <span class="ruby-identifier">customer_card</span>.<span class="ruby-identifier">type</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">last4</span> = <span class="ruby-identifier">customer_card</span>.<span class="ruby-identifier">last4</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">expiration</span> =  <span class="ruby-identifier">customer_card</span>.<span class="ruby-identifier">exp_month</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span>
    <span class="ruby-string">'/'</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">customer_card</span>.<span class="ruby-identifier">exp_year</span>.<span class="ruby-identifier">to_s</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- load_customer_info-source -->
          
        </div>

        

        
      </div><!-- load_customer_info-method -->

    
    </section><!-- protected-instance-method-details -->
  
  </section><!-- 5Buntitled-5D -->

</div><!-- documentation -->


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 3.12.2.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

